apiVersion: batch/v1
kind: Job
metadata:
  name: zabbix-change-admin-password
  namespace: monitoring
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      initContainers:
      - name: wait-for-zabbix-web
        image: curlimages/curl:latest
        command:
        - sh
        - -c
        - |
          echo "‚è≥ Aguardando Zabbix Web estar dispon√≠vel..."
          until curl -sf -X POST http://zabbix-web.monitoring.svc.cluster.local:8080/api_jsonrpc.php \
            -H "Content-Type: application/json" \
            -d '{"jsonrpc":"2.0","method":"apiinfo.version","params":[],"id":1}' >/dev/null 2>&1; do
            echo "   Aguardando..."
            sleep 5
          done
          echo "‚úÖ Zabbix Web dispon√≠vel!"
          sleep 10
      containers:
      - name: change-password
        image: curlimages/curl:latest
        env:
        - name: NEW_PASSWORD
          valueFrom:
            secretKeyRef:
              name: zabbix-secret
              key: admin-password
        command:
        - sh
        - -c
        - |
          #!/bin/sh
          set -e
          
          echo "üîê Alterando senha do usu√°rio Admin no Zabbix..."
          
          # Login com senha padr√£o
          echo "üîë Fazendo login com senha padr√£o..."
          AUTH_TOKEN=$(curl -s -X POST http://zabbix-web.monitoring.svc.cluster.local:8080/api_jsonrpc.php \
            -H "Content-Type: application/json" \
            -d '{
              "jsonrpc": "2.0",
              "method": "user.login",
              "params": {
                "username": "Admin",
                "password": "zabbix"
              },
              "id": 1
            }' | grep -o '"result":"[^"]*"' | cut -d'"' -f4)
          
          if [ -z "$AUTH_TOKEN" ] || [ "$AUTH_TOKEN" = "null" ]; then
            echo "‚ö†Ô∏è  Login com senha padr√£o falhou. Tentando com senha complexa..."
            
            AUTH_TOKEN=$(curl -s -X POST http://zabbix-web.monitoring.svc.cluster.local:8080/api_jsonrpc.php \
              -H "Content-Type: application/json" \
              -d '{
                "jsonrpc": "2.0",
                "method": "user.login",
                "params": {
                  "username": "Admin",
                  "password": "'"$NEW_PASSWORD"'"
                },
                "id": 1
              }' | grep -o '"result":"[^"]*"' | cut -d'"' -f4)
            
            if [ -z "$AUTH_TOKEN" ] || [ "$AUTH_TOKEN" = "null" ]; then
              echo "‚ùå N√£o foi poss√≠vel fazer login com nenhuma senha!"
              exit 1
            fi
            
            echo "‚úÖ Senha j√° est√° configurada corretamente!"
            exit 0
          fi
          
          echo "‚úÖ Login bem-sucedido! Token: ${AUTH_TOKEN:0:20}..."
          
          # Obter ID do usu√°rio Admin
          echo "üîç Obtendo ID do usu√°rio Admin..."
          USER_ID=$(curl -s -X POST http://zabbix-web.monitoring.svc.cluster.local:8080/api_jsonrpc.php \
            -H "Content-Type: application/json" \
            -d '{
              "jsonrpc": "2.0",
              "method": "user.get",
              "params": {
                "filter": {
                  "username": "Admin"
                }
              },
              "auth": "'"$AUTH_TOKEN"'",
              "id": 2
            }' | grep -o '"userid":"[^"]*"' | head -1 | cut -d'"' -f4)
          
          if [ -z "$USER_ID" ]; then
            echo "‚ùå N√£o foi poss√≠vel encontrar usu√°rio Admin!"
            exit 1
          fi
          
          echo "‚úÖ User ID: $USER_ID"
          
          # Alterar senha
          echo "üîÑ Alterando senha para senha complexa do Vault..."
          RESULT=$(curl -s -X POST http://zabbix-web.monitoring.svc.cluster.local:8080/api_jsonrpc.php \
            -H "Content-Type: application/json" \
            -d '{
              "jsonrpc": "2.0",
              "method": "user.update",
              "params": {
                "userid": "'"$USER_ID"'",
                "current_passwd": "zabbix",
                "passwd": "'"$NEW_PASSWORD"'"
              },
              "auth": "'"$AUTH_TOKEN"'",
              "id": 3
            }')
          
          if echo "$RESULT" | grep -q '"error"'; then
            echo "‚ùå Erro ao alterar senha:"
            echo "$RESULT"
            exit 1
          fi
          
          echo "‚úÖ Senha alterada com sucesso!"
          echo "üîê Nova senha: $NEW_PASSWORD"
          echo ""
          echo "Agora use: Admin / $NEW_PASSWORD"
