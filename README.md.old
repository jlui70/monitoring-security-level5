# ğŸ” Monitoring Stack - Security Level 5

**Enterprise-Grade Secrets Management com Kubernetes + Vault + External Secrets Operator**

[![Kubernetes](https://img.shields.io/badge/Kubernetes-1.27+-326CE5?logo=kubernetes&logoColor=white)](https://kubernetes.io/)
[![Vault](https://img.shields.io/badge/Vault-1.15+-000000?logo=vault&logoColor=white)](https://www.vaultproject.io/)
[![External Secrets](https://img.shields.io/badge/External_Secrets-0.9+-4285F4)](https://external-secrets.io/)
[![Grafana](https://img.shields.io/badge/Grafana-10.2-F46800?logo=grafana&logoColor=white)](https://grafana.com/)
[![Zabbix](https://img.shields.io/badge/Zabbix-7.0-D40000?logo=zabbix&logoColor=white)](https://www.zabbix.com/)
[![Prometheus](https://img.shields.io/badge/Prometheus-2.48-E6522C?logo=prometheus&logoColor=white)](https://prometheus.io/)

---

## ğŸš€ Quick Start (Setup AutomÃ¡tico)

**InstalaÃ§Ã£o completa em um Ãºnico comando:**

```bash
./setup.sh
```

> **Nota:** Se jÃ¡ existir um cluster, o script perguntarÃ¡ se deseja deletar e recriar (timeout 15s = mantÃ©m existente)

**Para garantir instalaÃ§Ã£o 100% limpa:**

```bash
kind delete cluster  # Limpar cluster anterior (se existir)
./setup.sh          # InstalaÃ§Ã£o do zero
```

Este script executa automaticamente:
1. âœ… Cria cluster Kind com port mappings
2. âœ… Instala External Secrets Operator
3. âœ… Deploy de Vault + MySQL + Zabbix + Prometheus + Grafana
4. âœ… Popula secrets no Vault
5. âœ… Sincroniza secrets via ESO
6. âœ… **Configura Zabbix** (templates, DNS, agent)
7. âœ… **Importa dashboards no Grafana**
8. âœ… Valida deployment completo

**Tempo estimado:** 5-8 minutos

**Resultado esperado:**
- âœ… Zabbix coletando 140+ itens
- âœ… Grafana com 2 dashboards funcionais
- âœ… Prometheus com targets ativos
- âœ… External Secrets sincronizados

---

## ğŸŒ Acessar ServiÃ§os

ApÃ³s `./setup.sh` concluir:

> **ğŸ” IMPORTANTE**: As senhas sÃ£o **geradas automaticamente** pelo Vault a cada deploy!  
> Elas serÃ£o exibidas no final do setup e salvas em `credentials.txt`

| ServiÃ§o | URL | Credenciais |
|---------|-----|-------------|
| **Zabbix** | http://localhost:30080 | Admin / *`<gerada pelo Vault>`* |
| **Grafana** | http://localhost:30300 | admin / *`<gerada pelo Vault>`* |
| **Prometheus** | http://localhost:30900 | - |

**Para ver as credenciais novamente:**
```bash
./scripts/show-credentials.sh
# ou
cat credentials.txt
```

**Dashboards Grafana:**
- ğŸ“Š **Node Exporter Prometheus** - MÃ©tricas do sistema via Prometheus
- ğŸ“ˆ **Zabbix Server** - MÃ©tricas via Zabbix Agent (CPU, RAM, Disco, Rede)

---

## ğŸ¯ Sobre o Projeto

**Level 5** Ã© a evoluÃ§Ã£o da sÃ©rie de projetos de monitoramento, trazendo **gerenciamento de secrets enterprise-grade** para Kubernetes usando **HashiCorp Vault** e **External Secrets Operator**.

### âœ¨ Principais Diferenciais

| CaracterÃ­stica | Level 3 (Docker Compose) | **Level 5 (Kubernetes)** |
|----------------|-------------------------|-------------------------|
| **Secrets Management** | Vault + .env | âœ… **Vault + ESO (zero .env)** |
| **Senha PadrÃ£o** | `Dev_Service_Random16_2024!@` | âœ… **`K8s_Service_Random16_Vault2024!@`** |
| **Senha Length** | 16-20 caracteres | âœ… **32-40 caracteres (2x maior!)** |
| **Senha Rotation** | Redeploy manual | âœ… **Redeploy = novas senhas aleatÃ³rias** |
| **OrquestraÃ§Ã£o** | Docker Compose | âœ… **Kubernetes** |
| **Secret Injection** | Containers leem .env | âœ… **DinÃ¢mico via ESO** |
| **Cloud Portability** | âŒ Somente local | âœ… **Kind/EKS/GKE/AKS** |
| **GitOps Ready** | âš ï¸ Parcial | âœ… **100% Manifests** |
| **RBAC Granular** | âŒ N/A | âœ… **Policies por serviÃ§o** |
| **Auto-Scaling** | âŒ Manual | âœ… **HPA/VPA Ready** |

---

## ğŸ—ï¸ Arquitetura

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Kubernetes Cluster                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              External Secrets Operator               â”‚   â”‚
â”‚  â”‚         (Sincroniza Vault â†’ K8s Secrets)             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â†•                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   Vault     â”‚    â”‚      Kubernetes Secrets          â”‚   â”‚
â”‚  â”‚   Pod       â”‚â†â”€â”€â”€â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚  â”‚             â”‚    â”‚  â”‚ mysql-secret            â”‚     â”‚   â”‚
â”‚  â”‚ KV v2:      â”‚    â”‚  â”‚ zabbix-secret           â”‚     â”‚   â”‚
â”‚  â”‚ secret/     â”‚    â”‚  â”‚ grafana-secret          â”‚     â”‚   â”‚
â”‚  â”‚ â”œâ”€ mysql/   â”‚    â”‚  â”‚ prometheus-secret       â”‚     â”‚   â”‚
â”‚  â”‚ â”œâ”€ zabbix/  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
â”‚  â”‚ â”œâ”€ grafana/ â”‚    â”‚                                   â”‚   â”‚
â”‚  â”‚ â””â”€ prom/    â”‚    â”‚                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  MySQL   â”‚  â”‚  Zabbix   â”‚  â”‚ Grafana  â”‚  â”‚Prometheusâ”‚  â”‚
â”‚  â”‚          â”‚  â”‚           â”‚  â”‚          â”‚  â”‚          â”‚  â”‚
â”‚  â”‚ â†‘ usa    â”‚  â”‚ â†‘ usa     â”‚  â”‚ â†‘ usa    â”‚  â”‚ â†‘ usa    â”‚  â”‚
â”‚  â”‚ secrets  â”‚  â”‚ secrets   â”‚  â”‚ secrets  â”‚  â”‚ secrets  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ”„ Fluxo de Secrets

1. **Vault Init Job** popula secrets no Vault (`secret/mysql/*`, `secret/zabbix/*`, etc.)
2. **External Secrets Operator** monitora `ExternalSecret` CRDs
3. **ESO** lÃª secrets do Vault via Kubernetes Auth
4. **ESO** cria/atualiza `Kubernetes Secrets` automaticamente
5. **Pods** consomem secrets via `envFrom` ou `volumeMounts`

**ğŸš¨ ZERO .env FILES** - Secrets 100% dinÃ¢micos!

---

## ğŸš€ Quick Start

### PrÃ©-requisitos

- **Docker** 24+
- **Kind** 0.20+
- **kubectl** 1.27+

### InstalaÃ§Ã£o em 2 comandos

```bash
# 1. Clone e entre no diretÃ³rio
git clone <repo-url> && cd monitoring-security-level5

# 2. Deploy completo
./scripts/deploy.sh
```

**Output esperado:**
```
âœ… DEPLOYMENT CONCLUÃDO!

ğŸ“ URLs de Acesso:
  Zabbix:     http://localhost:30080 (Admin/zabbix)
  Grafana:    http://localhost:30300 (admin/admin)
  Prometheus: http://localhost:30900

ğŸ” Secrets gerenciados pelo Vault:
  mysql-secret      Synced   12s
  zabbix-secret     Synced   11s
  grafana-secret    Synced   10s
  prometheus-secret Synced   9s
```

### ConfiguraÃ§Ã£o dos Agentes e Dashboards

```bash
# 3. Configurar Zabbix Agent
./scripts/configure-zabbix.sh

# 4. Configurar Grafana Datasources
./scripts/configure-grafana.sh
```

---

## ğŸ” SeguranÃ§a Enterprise-Grade

### Senhas Complexas Gerenciadas pelo Vault

**Todas as senhas sÃ£o complexas e armazenadas no Vault**:

- ğŸ”‘ **MySQL**: Senhas de 24+ caracteres (root + zabbix user)
- ğŸ”‘ **Zabbix**: Senha complexa para Admin Web (`Zabb1xAdm1n_S3cur3P@ss!`)
- ğŸ”‘ **Grafana**: Senha complexa para admin (`Gr@fan@Adm1n_S3cur3P@ss!`)
- ğŸ”‘ **Prometheus**: Senha complexa (futura autenticaÃ§Ã£o)

**CaracterÃ­sticas:**
- âœ… Senhas complexas (maiÃºsculas, minÃºsculas, nÃºmeros, sÃ­mbolos)
- âœ… MÃ­nimo 20 caracteres
- âœ… Armazenadas apenas no Vault (zero hardcoded nos manifests)
- âœ… Sincronizadas via External Secrets Operator
- âœ… **Consistentes entre deploys** (importante para configuraÃ§Ã£o)

> **ğŸ“ Nota**: Senhas sÃ£o fixas (nÃ£o aleatÃ³rias) para garantir compatibilidade com scripts de configuraÃ§Ã£o automÃ¡tica do Zabbix/Grafana. Em produÃ§Ã£o, use Vault Dynamic Secrets com rotaÃ§Ã£o automÃ¡tica.

### Recuperar Credenciais

```bash
# MÃ©todo 1: Script helper
./scripts/show-credentials.sh

# MÃ©todo 2: Arquivo local (criado no deploy)
cat credentials.txt

# MÃ©todo 3: Diretamente do Vault
kubectl exec -it -n monitoring vault-0 -- vault kv get secret/zabbix
kubectl exec -it -n monitoring vault-0 -- vault kv get secret/grafana
```

### RotaÃ§Ã£o de Senhas (ProduÃ§Ã£o)

**Para ambiente de demonstraÃ§Ã£o**: Senhas sÃ£o fixas para garantir automaÃ§Ã£o completa.

**Para produÃ§Ã£o**, recomenda-se implementar:

1. **Vault Dynamic Database Secrets** (rotaÃ§Ã£o automÃ¡tica MySQL)
2. **AppRole Authentication** (ao invÃ©s de token fixo)
3. **PolÃ­ticas de TTL** para secrets com expiraÃ§Ã£o automÃ¡tica
4. **Audit logging** do Vault

```bash
# Exemplo de rotaÃ§Ã£o manual (demo):
./scripts/cleanup.sh
./setup.sh
# Mesmas credenciais complexas serÃ£o recriadas
```

---

## ğŸ“¦ Componentes Instalados

| Componente | VersÃ£o | Porta | DescriÃ§Ã£o |
|-----------|--------|-------|-----------|
| **Vault** | 1.15.0 | 8200 | Gerenciamento de secrets |
| **External Secrets** | Latest | - | SincronizaÃ§Ã£o Vaultâ†’K8s |
| **MySQL** | 8.3 | 3306 | Banco de dados Zabbix |
| **Zabbix Server** | 7.0.5 | 10051 | Motor de monitoramento |
| **Zabbix Web** | 7.0.5 | **30080** | Interface web |
| **Zabbix Agent2** | 7.0.5 | 10050 | Agent de coleta |
| **Grafana** | 10.2.3 | **30300** | Dashboards e visualizaÃ§Ã£o |
| **Prometheus** | 2.48.1 | **30900** | MÃ©tricas time-series |
| **Node Exporter** | 1.7.0 | 9100 | MÃ©tricas de host |

---

## ğŸ” Estrutura de Secrets no Vault

```
secret/ (KV v2)
â”œâ”€â”€ mysql/
â”‚   â”œâ”€â”€ root-password       â†’ MySQL root password
â”‚   â””â”€â”€ zabbix-password     â†’ Zabbix DB user password
â”œâ”€â”€ zabbix/
â”‚   â”œâ”€â”€ admin-password      â†’ Zabbix Admin UI password
â”‚   â”œâ”€â”€ database-password   â†’ Zabbix DB password
â”‚   â””â”€â”€ server-password     â†’ Zabbix Server password
â”œâ”€â”€ grafana/
â”‚   â”œâ”€â”€ admin-password      â†’ Grafana admin password
â”‚   â””â”€â”€ database-password   â†’ Grafana DB password (futuro)
â””â”€â”€ prometheus/
    â””â”€â”€ admin-password      â†’ Prometheus admin password (futuro)
```

### ğŸ”‘ PolÃ­ticas de Acesso (Vault Policies)

- **mysql-policy**: Acesso somente a `secret/mysql/*`
- **zabbix-policy**: Acesso a `secret/zabbix/*` e `secret/mysql/*`
- **grafana-policy**: Acesso a `secret/grafana/*` e `secret/zabbix/*`
- **prometheus-policy**: Acesso a `secret/prometheus/*`

**ğŸ›¡ï¸ Least Privilege** - Cada serviÃ§o acessa apenas seus secrets!

---

## ğŸŒ Suporte Multi-Cloud

### Estrutura de Deployment

```
kubernetes/
â”œâ”€â”€ 01-namespace/          # 100% comum
â”œâ”€â”€ 02-vault/              # 100% comum
â”œâ”€â”€ 03-external-secrets/   # 100% comum
â”œâ”€â”€ 04-storage/
â”‚   â”œâ”€â”€ kind/              # â† Local Kind
â”‚   â”œâ”€â”€ aws/               # â† AWS EKS (EBS)
â”‚   â”œâ”€â”€ gcp/               # â† GCP GKE (PD-SSD)
â”‚   â””â”€â”€ azure/             # â† Azure AKS (Managed Premium)
â”œâ”€â”€ 05-mysql/              # 100% comum
â”œâ”€â”€ 06-zabbix/             # 100% comum
â”œâ”€â”€ 07-prometheus/         # 100% comum
â”œâ”€â”€ 08-grafana/            # 100% comum
â””â”€â”€ 09-node-exporter/      # 100% comum
```

### Deploy em Diferentes Clouds

<details>
<summary><b>ğŸ“˜ AWS EKS</b></summary>

```bash
# 1. Criar cluster EKS
eksctl create cluster \
  --name monitoring-cluster \
  --region us-east-1 \
  --nodegroup-name standard-workers \
  --node-type t3.medium \
  --nodes 3

# 2. Aplicar storage class AWS
kubectl apply -f kubernetes/04-storage/aws/storage-class.yaml

# 3. Seguir deploy normal
kubectl apply -f kubernetes/01-namespace/
kubectl apply -f kubernetes/02-vault/
# ... restante igual
```

</details>

<details>
<summary><b>ğŸ“— GCP GKE</b></summary>

```bash
# 1. Criar cluster GKE
gcloud container clusters create monitoring-cluster \
  --zone us-central1-a \
  --num-nodes 3 \
  --machine-type n1-standard-2

# 2. Aplicar storage class GCP
kubectl apply -f kubernetes/04-storage/gcp/storage-class.yaml

# 3. Seguir deploy normal
kubectl apply -f kubernetes/01-namespace/
kubectl apply -f kubernetes/02-vault/
# ... restante igual
```

</details>

<details>
<summary><b>ğŸ“™ Azure AKS</b></summary>

```bash
# 1. Criar cluster AKS
az aks create \
  --resource-group monitoring-rg \
  --name monitoring-cluster \
  --node-count 3 \
  --node-vm-size Standard_DS2_v2

# 2. Aplicar storage class Azure
kubectl apply -f kubernetes/04-storage/azure/storage-class.yaml

# 3. Seguir deploy normal
kubectl apply -f kubernetes/01-namespace/
kubectl apply -f kubernetes/02-vault/
# ... restante igual
```

</details>

**ğŸ¯ 95% cÃ³digo comum, 5% cloud-specific!**

---

## ğŸ§ª ValidaÃ§Ã£o

### Verificar Secrets Sincronizados

```bash
# Status dos ExternalSecrets
kubectl get externalsecrets -n monitoring

# Output:
NAME                STORE           REFRESH   STATUS
mysql-secret        vault-backend   1h        SecretSynced
zabbix-secret       vault-backend   1h        SecretSynced
grafana-secret      vault-backend   1h        SecretSynced
prometheus-secret   vault-backend   1h        SecretSynced
```

### Verificar Secrets Kubernetes Criados

```bash
kubectl get secrets -n monitoring | grep -E 'mysql|zabbix|grafana|prometheus'

# Output:
mysql-secret        Opaque   2      5m
zabbix-secret       Opaque   5      5m
grafana-secret      Opaque   2      5m
prometheus-secret   Opaque   1      5m
```

### Testar Acesso ao Vault

```bash
# Port-forward para Vault
kubectl port-forward -n monitoring svc/vault 8200:8200 &

# Listar secrets
export VAULT_ADDR='http://localhost:8200'
export VAULT_TOKEN='vault-dev-root-token'
vault kv list secret/

# Output:
Keys
----
grafana/
mysql/
prometheus/
zabbix/
```

---

## ğŸ”§ Troubleshooting

### ExternalSecret nÃ£o sincroniza

```bash
# 1. Verificar logs do ESO
kubectl logs -n external-secrets-system deployment/external-secrets

# 2. Verificar SecretStore
kubectl describe secretstore vault-backend -n monitoring

# 3. Verificar Vault auth
kubectl exec -it -n monitoring vault-0 -- vault auth list
```

### Pods nÃ£o iniciam

```bash
# 1. Verificar se secrets existem
kubectl get secrets -n monitoring

# 2. Verificar InitContainers
kubectl describe pod <pod-name> -n monitoring

# 3. Verificar logs
kubectl logs <pod-name> -n monitoring -c <container-name>
```

### MySQL schema nÃ£o criado

```bash
# 1. Verificar job
kubectl logs -n monitoring job/mysql-init-schema

# 2. Verificar tabelas manualmente
kubectl exec -it -n monitoring mysql-0 -- mysql -uzabbix -p -e "USE zabbix; SHOW TABLES;" | wc -l
# Deve retornar 208+
```

---

## ğŸ§¹ Limpeza

```bash
# Deletar cluster completo
./scripts/cleanup.sh

# Ou manual:
kind delete cluster
docker ps -aq --filter "name=kind" | xargs docker rm -f
```

---

## ğŸ“š DocumentaÃ§Ã£o Adicional

- **[Vault Configuration Guide](docs/VAULT-CONFIG.md)** - Detalhes de configuraÃ§Ã£o do Vault
- **[Multi-Cloud Deployment](docs/MULTI-CLOUD.md)** - Guias especÃ­ficos por cloud
- **[Security Best Practices](docs/SECURITY.md)** - RecomendaÃ§Ãµes de seguranÃ§a
- **[Troubleshooting Guide](docs/TROUBLESHOOTING.md)** - SoluÃ§Ãµes de problemas comuns

---

## ğŸ“ EvoluÃ§Ã£o da SÃ©rie

| Level | Secrets Management | OrquestraÃ§Ã£o | Status |
|-------|-------------------|--------------|--------|
| **1** | âŒ Hardcoded | Docker Compose | âœ… Completo |
| **2** | âš ï¸ .env files | Docker Compose | âœ… Completo |
| **3** | âœ… Vault + .env | Docker Compose | âœ… Completo |
| **4** | âœ… AWS Secrets Manager | Docker Compose | âœ… Completo |
| **5** | âœ…âœ… **Vault + ESO** | **Kubernetes** | **ğŸ“ ATUAL** |

---

## ğŸ“„ LicenÃ§a

MIT License - Veja [LICENSE](LICENSE) para detalhes.

---

## ğŸ¤ Contribuindo

ContribuiÃ§Ãµes sÃ£o bem-vindas! Veja [CONTRIBUTING.md](CONTRIBUTING.md).

---

## ğŸ“ Suporte

- **Issues**: [GitHub Issues](https://github.com/seu-usuario/monitoring-security-level5/issues)
- **Discussions**: [GitHub Discussions](https://github.com/seu-usuario/monitoring-security-level5/discussions)

---

<div align="center">

**ğŸ” Enterprise-Grade Secrets Management no Kubernetes** 

Desenvolvido com â¤ï¸ para a comunidade DevOps/SRE

</div>
